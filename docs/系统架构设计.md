# 财报点评系统 - 系统架构设计

## 1. 系统概述

### 1.1 业务目标

解决研究员在财报集中发布期工作量大、难以全面覆盖的痛点，实现智能化财报点评。

### 1.2 核心原则

1. **数据客观性**：能够提前计算的指标使用代码逻辑，避免LLM计算导致的GIGO
2. **架构可扩展**：支持行业扩展、数据源扩展
3. **配置独立性**：提示词和行业配置独立管理
4. **职责单一性**：每个模块职责明确，便于维护

## 2. 架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                      应用层                              │
│  generate_report.py - 主程序入口                        │
│  test_report_generation.py - 测试程序                   │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                     业务逻辑层                           │
│                                                          │
│  ┌────────────────────────────────────────────┐        │
│  │   ReportGenerator（报告生成器）              │        │
│  │   - 协调各模块                               │        │
│  │   - 调用LLM生成报告                          │        │
│  └────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                     服务层                               │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ Financial    │  │ Vector       │  │ Indicator    │ │
│  │ DataService  │  │ Retriever    │  │ Extractor    │ │
│  │              │  │              │  │              │ │
│  │ 获取结构化   │  │ 获取非结构   │  │ 计算技术     │ │
│  │ 财报数据     │  │ 化文本数据   │  │ 指标         │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                     数据层                               │
│                                                          │
│  ┌──────────────┐           ┌──────────────┐           │
│  │ PostgreSQL   │           │   Milvus     │           │
│  │              │           │              │           │
│  │ 结构化财报   │           │ 非结构化     │           │
│  │ 三表数据     │           │ 文本向量     │           │
│  └──────────────┘           └──────────────┘           │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                     配置层                               │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Settings   │  │  Industry    │  │   Prompts    │ │
│  │   环境配置   │  │  行业配置    │  │   提示词     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 数据流程

```
1. 用户输入
   ↓
2. [FinancialDataService] 从PostgreSQL获取财报三表
   ↓
3. [IndicatorExtractor] 基于行业配置计算技术指标
   ↓                           ↓
4. [VectorRetriever]      结构化指标数据
   从Milvus检索文本        (客观、准确)
   ↓                           ↓
5. 非结构化上下文 --------→ [ReportGenerator]
   (业务背景、说明)         
   ↓
6. [LLM] 基于Prompt模板 + 结构化指标 + 非结构化上下文
   ↓
7. 生成专业财报点评报告
```

## 3. 核心模块设计

### 3.1 配置模块 (src/config/)

#### 3.1.1 Settings (settings.py)
- **职责**：管理环境变量和系统配置
- **配置项**：
  - LLM配置（DeepSeek API）
  - 数据库配置（PostgreSQL）
  - Milvus配置
  - Embedding模型配置

#### 3.1.2 IndustryConfig (industry_configs.py)
- **职责**：定义行业特征和指标体系
- **扩展性**：支持新增行业配置
- **指标分类**：
  - 核心指标（CORE）：如营业收入增速、净利润增速
  - 辅助指标（AUXILIARY）：如毛利率、研发费用率
  - 个性化指标（SPECIFIC）：如合同负债、存货

#### 3.1.3 PromptManager (prompts.py)
- **职责**：集中管理所有提示词
- **模板类型**：
  - 系统提示词：定义AI角色和分析原则
  - 核心指标分析提示词
  - 辅助指标分析提示词
  - 个性化指标分析提示词
  - 最终报告生成提示词

### 3.2 数据服务层 (src/database/)

#### 3.2.1 FinancialDataService
- **职责**：从PostgreSQL获取结构化财报数据
- **功能**：
  - 获取利润表（income_statement）
  - 获取资产负债表（balance_sheet）
  - 获取现金流量表（cash_flow）
  - 获取历史期数据
  - 获取完整财务数据包（含上期对比）
- **设计**：使用SQLAlchemy连接，支持连接池

### 3.3 检索服务层 (src/retrieval/)

#### 3.3.1 VectorRetriever
- **职责**：从Milvus检索非结构化文本数据
- **功能**：
  - 按公司检索
  - 按期间检索
  - 检索历史报告
  - 检索相似内容
  - 组装分析上下文
- **技术**：使用Sentence-Transformers生成查询向量

### 3.4 指标提取层 (src/extractors/)

#### 3.4.1 IndicatorExtractor
- **职责**：基于行业配置计算客观技术指标
- **输入**：结构化财务数据（当期+上期）
- **输出**：按优先级分类的指标字典
- **核心方法**：
  - `extract_indicators()` - 主入口
  - `_extract_core_indicators()` - 提取核心指标
  - `_extract_auxiliary_indicators()` - 提取辅助指标
  - `_extract_specific_indicators()` - 提取个性化指标
  - `_calculate_growth_rate()` - 计算增长率
  - `_calculate_gross_margin()` - 计算毛利率
  - `format_indicators_for_display()` - 格式化显示

### 3.5 分析生成层 (src/analysis/)

#### 3.5.1 ReportGenerator
- **职责**：协调所有模块，生成完整报告
- **流程**：
  1. 获取结构化数据
  2. 计算客观指标
  3. 检索非结构化上下文
  4. 分步分析（核心→辅助→个性化）
  5. 生成最终报告
- **LLM调用**：
  - 4次LLM调用（3次分析 + 1次报告生成）
  - 每次调用都基于结构化的Prompt模板
  - 输入数据结合了客观指标和业务上下文

### 3.6 摄入服务 (src/ingestion/)

#### 3.6.1 ReportIngestionService
- **职责**：解析PDF财报，存入Milvus
- **功能**：
  - PDF文本提取
  - 文本智能分块
  - 生成Embedding
  - 存储到Milvus
- **应用**：独立运行，与报告生成解耦

### 3.7 解析器 (src/parsers/)

#### 3.7.1 FinancialPDFParser
- **职责**：从PDF提取纯文本
- **简化**：仅提取文本，不处理表格（表格由数据库提供）

## 4. 数据库设计

### 4.1 PostgreSQL表结构

基于Wind数据结构：

- **a_share_income_statement**：利润表
- **a_share_balance_sheet**：资产负债表
- **a_share_cash_flow_statement**：现金流量表

主键：`(stkcd, accper, typrep)`
- `stkcd`: 股票代码
- `accper`: 报告期
- `typrep`: 报表类型（A=合并，B=母公司）

### 4.2 Milvus Collection结构

Collection名称：`financial_reports`

字段：
- `report_id`: 主键
- `company_name`: 公司名称
- `company_code`: 公司代码
- `report_period`: 报告期
- `chunk_index`: 块索引
- `chunk_type`: 块类型（full_text/summary/management_discussion等）
- `chunk_text`: 文本内容
- `embedding`: 向量（768维，bge-base-zh-v1.5）
- `file_path`: 源文件路径
- `created_at`: 创建时间

索引：HNSW，余弦相似度

## 5. 行业配置体系

### 5.1 计算机行业配置示例

**行业特征**：
1. 成长性导向：TMT高风偏，成长性显著影响估值
2. 高估值特征：PE倍数偏高，采用终局估值法
3. 业绩不可预测：主观调节能力强

**核心指标**：
1. 营业收入增速（最重要）
2. 细分板块收入增速
3. 净利润增速

**辅助指标**：
1. 毛利率
2. 研发费用率
3. 销售费用率

**个性化指标**：
1. 合同负债（订阅制公司）
2. 存货（硬件公司）

### 5.2 扩展新行业

步骤：
1. 定义 `IndustryConfig` 对象
2. 配置 `IndicatorConfig` 列表
3. 注册到 `IndustryConfigManager`
4. （可选）定制行业Prompt

## 6. 提示词设计

### 6.1 提示词分层

1. **系统提示词**：定义AI角色、行业理解、分析原则
2. **任务提示词**：针对具体任务（分析核心指标、辅助指标等）
3. **输出格式要求**：规范输出结构

### 6.2 数据输入结构

提示词 + 结构化数据 = 有框架的分析输入

示例：
```
## 核心指标数据
- 营业收入: 123.45亿元，同比增长 +25.30%
- 净利润: 23.45亿元，同比增长 +18.50%
...
```

## 7. 扩展性设计

### 7.1 行业扩展
- 新增行业配置类
- 定义行业指标
- 注册到管理器

### 7.2 数据源扩展
- 新增数据服务类
- 实现统一接口
- 在ReportGenerator中集成

### 7.3 指标扩展
- 在行业配置中添加指标定义
- 在IndicatorExtractor中实现计算逻辑
- 更新相关Prompt

## 8. 技术栈

- **编程语言**：Python 3.10+
- **LLM框架**：LangChain + DeepSeek
- **向量数据库**：Milvus 2.4+
- **关系数据库**：PostgreSQL 16+
- **Embedding模型**：Sentence-Transformers (BGE)
- **PDF解析**：pdfplumber
- **配置管理**：Pydantic Settings
- **日志**：Loguru

## 9. 部署架构

```
┌─────────────┐
│   用户端    │
└──────┬──────┘
       │
┌──────▼──────┐
│ 应用服务器   │
│ (Python)    │
└──────┬──────┘
       │
   ┌───┴───┬──────────┬──────────┐
   │       │          │          │
┌──▼──┐ ┌──▼───┐ ┌────▼────┐ ┌──▼──────┐
│ LLM │ │ DB   │ │ Milvus  │ │ Embed   │
│ API │ │(PSQL)│ │         │ │ Model   │
└─────┘ └──────┘ └─────────┘ └─────────┘
```

## 10. 性能优化

### 10.1 数据库优化
- 索引优化：在 `stkcd` 和 `accper` 上建立复合索引
- 连接池：使用SQLAlchemy连接池

### 10.2 Milvus优化
- 索引类型：HNSW（高性能近似最近邻搜索）
- 向量维度：768（BGE-base平衡性能和效果）
- 批量插入：减少网络开销

### 10.3 LLM调用优化
- 分步调用：避免单次Token过长
- 上下文裁剪：限制非结构化文本长度
- 缓存机制：可选缓存历史分析结果

## 11. 安全性设计

### 11.1 数据安全
- 数据库账号密码加密存储（环境变量）
- Milvus账号密码认证

### 11.2 输入验证
- 验证股票代码格式
- 验证报告期格式
- 检查行业配置存在性

### 11.3 错误处理
- 数据库连接异常捕获
- Milvus连接异常捕获
- LLM API异常捕获
- 详细的日志记录

## 12. 监控与日志

### 12.1 日志体系
- 使用Loguru记录详细日志
- 日志级别：DEBUG、INFO、WARNING、ERROR
- 日志轮转：按天轮转，保留7天

### 12.2 关键指标
- LLM调用次数和耗时
- 数据库查询耗时
- Milvus检索耗时
- 报告生成总耗时

## 13. 未来规划

### 13.1 短期（1-2月）
- [ ] 支持更多行业（医药、消费等）
- [ ] 优化Prompt模板
- [ ] 增加报告质量评分

### 13.2 中期（3-6月）
- [ ] 接入公告数据源
- [ ] 支持行业对比分析
- [ ] 开发Web界面

### 13.3 长期（6-12月）
- [ ] 支持异动点评
- [ ] 支持行业报告生成
- [ ] 训练微调专用模型

